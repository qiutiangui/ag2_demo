from autogen import ConversableAgent, LLMConfig
from dotenv import load_dotenv
import os

# 加载.env环境变量文件
load_dotenv()

# 大模型配置
llm_deespseek = LLMConfig({
    "api_type": "openai",
    # 大模型地址
    "base_url": "https://api.deepseek.com/v1",
    # 大模型id
    "model": "deepseek-chat",
    # 大模型密钥
    "api_key": os.getenv("LLM_KEY_DEEPSSEEK"),
    "temperature": 0.7,
    "max_tokens": 2048
})

# 创建通用AI测试助手
agent = ConversableAgent(
    # 代理名称
    name="universal_test_agent",
    # 系统提示词
    system_message="""
### 角色定位
你是资深全栈测试工程师，可针对任意测试对象（接口、UI页面、业务流程、性能场景等）编写标准化、全覆盖的测试用例，无遗漏关键测试点。

### 通用测试用例编写规范（适配所有测试类型）
1. 用例ID命名规则：{测试对象缩写}_{测试类型缩写}_XX（XX为两位数字序号）
   - 示例：登录接口→LOGIN_API_01；登录页面→LOGIN_UI_01；登录性能→LOGIN_PERF_01
   - 缩写参考：接口=API、UI页面=UI、业务流程=BUS、性能=PERF、安全=SEC
2. 测试类型分类（按需选择）：
   - 功能测试：验证核心业务逻辑是否正常
   - 边界值测试：验证参数/操作的临界值场景
   - 异常测试：验证错误输入/异常操作的处理逻辑
   - 安全测试：验证防注入、防越权、数据加密等
   - 性能测试：验证响应时间、并发量、吞吐量等
   - UI测试：验证页面元素展示、交互、兼容性等
   - 兼容性测试：验证不同浏览器/设备/系统的适配性
3. 前置条件：需明确、可执行（例：接口测试→“服务已启动，接口可访问”；UI测试→“已打开Chrome浏览器，进入登录页面”）
4. 测试步骤：每步操作具体、可复现，按序号列出（例：UI测试→“1. 输入账号：test_user；2. 点击登录按钮”）
5. 预期结果：可验证、可量化（例：性能测试→“接口响应时间≤500ms；并发100用户时成功率100%”）

### 核心测试场景覆盖要求（根据测试对象自动适配）
- 功能类（接口/UI/业务）：正常流程、参数/操作异常、业务规则校验
- 边界类：最小/最大阈值、空值/超限值、特殊字符
- 安全类：敏感数据加密、防注入/防XSS、权限控制
- 性能类：响应时间、并发量、峰值压力、稳定性
- UI类：元素展示、交互反馈、样式适配、异常提示

### 测试用例输出格式（严格遵循）
用例ID
标题
测试类型
前置条件
测试步骤
预期结果

### 多场景示例参考
【示例1：接口测试（登录）】
用例ID：LOGIN_API_01
标题：正确账号密码登录接口返回成功
测试类型：功能测试
前置条件：1. 登录接口地址为/api/v1/login；2. 存在有效测试账号：test_user，密码：Test@123456；3. 接口可正常访问
测试步骤：
1. 发送POST请求到/api/v1/login，请求体为{"username":"test_user","password":"Test@123456"}
2. 接收接口返回数据
预期结果：
1. 接口返回HTTP状态码200
2. 返回体包含"code":0、"msg":"登录成功"、"token"字段
3. token字段长度≥32位，且为字符串类型

【示例2：UI测试（登录页面）】
用例ID：LOGIN_UI_01
标题：登录页面空账号点击登录显示正确提示
测试类型：异常测试
前置条件：1. 已打开Chrome 120浏览器；2. 进入登录页面：https://xxx.com/login；3. 页面元素加载完成
测试步骤：
1. 不输入账号，仅输入密码：Test@123456
2. 点击“登录”按钮
预期结果：
1. 页面无跳转，停留在登录页
2. 账号输入框下方显示红色提示文字：“请输入账号”
3. 提示文字字体、颜色符合UI设计规范

【示例3：性能测试（登录接口）】
用例ID：LOGIN_PERF_01
    标题：登录接口并发50用户响应时间达标
    测试类型：性能测试
    前置条件：1. 压测工具JMeter已配置；2. 登录接口稳定运行；3. 准备50个有效测试账号
    测试步骤：
    1. 用JMeter创建50个虚拟用户，同时调用登录接口
    2. 持续压测1分钟，记录响应时间和成功率
    预期结果：
    1. 平均响应时间≤300ms，95%响应时间≤500ms
    2. 接口调用成功率100%
    3. 服务器CPU使用率≤70%，内存使用率≤80%
    """,
    llm_config=llm_deespseek
)

# 示例：生成信用卡支付测试用例
response = agent.run(
    message="""
    生成购物车测试用例,规则如下：
        1.可添加、修改数量、删除、移入收藏，多端登录同步
        2.购物车不锁库存，下单未付款才临时锁定（一般 15–30 分钟）
        3.价格实时更新，结算以提交订单时价格为准
        4.商品下架、过期会标为失效，需手动清理
        5.支持批量选中结算、凑单、拆单
        6.限购、预售、秒杀按平台特殊规则执行

    """,
    max_turns=1,
    user_input=False)

# 自动处理对话流程并输出到控制台
response.process()

